<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.16.9/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <title >T√≠nh ƒêi·ªÉm H·ªçc Ph·∫ßn</title>
    <link rel="icon" href="https://i.postimg.cc/xCmDcCRT/Logo-Truong-Dai-hoc-Mo-Dia-chat.jpg" type="image/x-icon">
    <link rel="stylesheet" href="index.css">
</head>
<body>
    <!-- Ph·∫ßn hi·ªÉn th·ªã t·ªïng ƒëi·ªÉm -->
    <div class="totals-container">
        <div class="totals">
            <div class="total-item">üìö T·ªïng t√≠n ch·ªâ: <span id="totalCredits">0</span></div>
            <div class="total-item">üîü H·ªá 10: <span id="totalGrade10">0.0</span></div>
            <div class="total-item">4Ô∏è‚É£ H·ªá 4: <span id="totalGrade4">0.0</span></div>
        </div>
    </div>
    <!-- Th√™m/S·ª≠a ƒëi·ªÉm -->
    <div class="container">
        <h1>T√≠nh ƒêi·ªÉm H·ªçc Ph·∫ßnüëÄ</h1>
        <label for="courseName">T√™n h·ªçc ph·∫ßn:</label>
        <input type="text" id="courseName">

        <label for="creditHours">T√≠n ch·ªâ:</label>
        <input type="number" id="creditHours" min="1">

        <label for="gradeC">ƒêi·ªÉm C:</label>
        <input type="number" id="gradeC" min="0" max="10">

        <label for="gradeB">ƒêi·ªÉm B:</label>
        <input type="number" id="gradeB" min="0" max="10">

        <label for="gradeA">ƒêi·ªÉm A:</label>
        <input type="number" id="gradeA" min="0" max="10">

        <button onclick="addCourse()">Th√™m h·ªçc ph·∫ßn</button>
        <!-- B·∫£ng hi·ªÉn th·ªã d·ªØ li·ªáu -->
        <div class="container mt-4">
            <div class="table-responsive"> <!-- Cho ph√©p cu·ªôn ngang n·∫øu b·∫£ng qu√° r·ªông -->
                <table class="table table-striped table-hover table-bordered text-center align-middle">
                    <thead class="table-primary">
                        <tr>
                            <th>T√™n h·ªçc ph·∫ßn</th>
                            <th>T√≠n ch·ªâ</th>
                            <th>ƒêi·ªÉm C</th>
                            <th>ƒêi·ªÉm B</th>
                            <th>ƒêi·ªÉm A</th>
                            <th>ƒêi·ªÉm h·ªá 10</th>
                            <th>ƒêi·ªÉm h·ªá ch·ªØ</th>
                            <th>Ch·ªçn ƒëi·ªÉm mu·ªën ƒë·ªïi</th>
                            <th>Thao t√°c</th>
                        </tr>
                    </thead>
                    <tbody id="courseTableBody"></tbody>
                </table>
            </div>
        </div>
        <button class="round-button" onclick="toggleCells()">·∫®n ƒëi·ªÉm th√†nh ph·∫ßn</button>
        <br>
         <!-- Form Upload File -->
        <form action="/" method="POST" enctype="multipart/form-data" class="p-4 bg-light shadow rounded text-center">
          <input type="file" name="file" id="fileInput" class="form-control mb-3 p-3 rounded" accept=".xlsx" required>
        </form>
        <br>
        <button onclick="exportToCSV()">Xu·∫•t CSV</button>
        <button onclick="exportToExcel()">Xu·∫•t Excel</button>
    </div>

    <script>
        let selectedRow = null;

        function calculateGrades(gradeC, gradeB, gradeA) {
            const grade10 = (gradeC * 0.1 + gradeB * 0.3 + gradeA * 0.6).toFixed(1);

            let grade4;
            if (grade10 < 4) {
                grade4 = "F";
            } else if (grade10 < 5) {
                grade4 = "D";
            } else if (grade10 < 5.5) {
                grade4 = "D+";
            } else if (grade10 < 6.5) {
                grade4 = "C";
            } else if (grade10 < 7) {
                grade4 = "C+";
            } else if (grade10 < 8) {
                grade4 = "B";
            } else if (grade10 < 8.5) {
                grade4 = "B+";
            } else if (grade10 < 9) {
                grade4 = "A";
            } else {
                grade4 = "A+";
            }
            return { grade10, grade4 };
        }

        function updateTotals() {
    const tableBody = document.getElementById('courseTableBody');
    totalCredits = 0;
    totalGrade10 = 0;
    totalGrade4 = 0;
    for (let i = 0; i < tableBody.rows.length; i++) {
        const row = tableBody.rows[i];
        const credits = parseInt(row.cells[1].innerText);
        const grade10 = parseFloat(row.cells[5].innerText);
        // L·∫•y gi√° tr·ªã ƒëi·ªÉm h·ªá 4 t·ª´ select trong cell[7]
        const selectEl = row.cells[7].querySelector("select");
        let grade4;
        if (selectEl) {
            grade4 = selectEl.value;
        } else {
            // N·∫øu kh√¥ng c√≥ select th√¨ l·∫•y gi√° tr·ªã g·ªëc t·ª´ cell[6]
            grade4 = row.cells[6].innerText;
        }
        console.log(grade4);
        totalCredits += credits;
        totalGrade10 += credits * grade10;
        totalGrade4 += credits * convertGrade4ToNumber(grade4);
    }
    document.getElementById('totalCredits').innerText = totalCredits;
    document.getElementById('totalGrade10').innerText = (totalGrade10 / totalCredits).toFixed(2);
    document.getElementById('totalGrade4').innerText = (totalGrade4 / totalCredits).toFixed(2);
}

function convertGrade4ToNumber(grade4) {
    switch (grade4) {
        case "F":
            return 0.0;
        case "D":
            return 1.0;
        case "D+":
            return 1.5;
        case "C":
            return 2.0;
        case "C+":
            return 2.5;
        case "B":
            return 3.0;
        case "B+":
            return 3.5;
        case "A":
            return 3.7;
        case "A+":
            return 4.0;
        default:
            return 0;
    }
}   
function addCourse() {
  const courseName = document.getElementById('courseName').value;
  const creditHours = document.getElementById('creditHours').value;
  const gradeC = parseFloat(document.getElementById('gradeC').value);
  const gradeB = parseFloat(document.getElementById('gradeB').value);
  const gradeA = parseFloat(document.getElementById('gradeA').value);

  //Ki·ªÉm tra
  if (!courseName || !creditHours || isNaN(gradeC) || isNaN(gradeB) || isNaN(gradeA)) {
      alert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin.");
      return;
  }
  if (gradeC < 0 || gradeC > 10 || gradeB < 0 || gradeB > 10 || gradeA < 0 || gradeA > 10) {
      alert("ƒêi·ªÉm ph·∫£i n·∫±m trong kho·∫£ng t·ª´ 0 ƒë·∫øn 10.");
      return;
  }

  const { grade10, grade4 } = calculateGrades(gradeC, gradeB, gradeA);

  const tableBody = document.getElementById('courseTableBody');
  if (selectedRow) {
      selectedRow.cells[0].innerText = courseName;
      selectedRow.cells[1].innerText = creditHours;
      selectedRow.cells[2].innerText = gradeC;
      selectedRow.cells[3].innerText = gradeB;
      selectedRow.cells[4].innerText = gradeA;
      selectedRow.cells[5].innerText = grade10;
      selectedRow.cells[6].innerText = grade4;
      selectedRow = null;
  } else {
      const newRow = tableBody.insertRow();
      newRow.insertCell(0).innerText = courseName;
      newRow.insertCell(1).innerText = creditHours;
      newRow.insertCell(2).innerText = gradeC;
      newRow.insertCell(3).innerText = gradeB;
      newRow.insertCell(4).innerText = gradeA;
      newRow.insertCell(5).innerText = grade10;
      newRow.insertCell(6).innerText = grade4;
      const actionsCell = newRow.insertCell(7);
      actionsCell.innerHTML = `
          <div class="btn-group">
              <button onclick="editCourse(this)">S·ª≠a</button>
              <button class="delete-button" onclick="deleteCourse(this)">X√≥a</button>
          </div>
      `;
  }

  document.getElementById('courseName').value = '';
  document.getElementById('creditHours').value = '';
  document.getElementById('gradeC').value = '';
  document.getElementById('gradeB').value = '';
  document.getElementById('gradeA').value = '';

  updateTotals();
}

        function editCourse(button) {
            selectedRow = button.parentElement.parentElement.parentElement;
            document.getElementById('courseName').value = selectedRow.cells[0].innerText;
            document.getElementById('creditHours').value = selectedRow.cells[1].innerText;
            document.getElementById('gradeC').value = selectedRow.cells[2].innerText;
            document.getElementById('gradeB').value = selectedRow.cells[3].innerText;
            document.getElementById('gradeA').value = selectedRow.cells[4].innerText;
        }

        function deleteCourse(button) {
            const row = button.parentElement.parentElement.parentElement;
            row.remove();
            updateTotals();
        }
        function exportToCSV() {
    const rows = [["T√™n h·ªçc ph·∫ßn", "T√≠n ch·ªâ", "ƒêi·ªÉm C", "ƒêi·ªÉm B", "ƒêi·ªÉm A", "ƒêi·ªÉm h·ªá 10", "ƒêi·ªÉm h·ªá 4"]];
    const table = document.getElementById("courseTableBody");
    
    for (let i = 0; i < table.rows.length; i++) {
        const rowData = [];
        for (let j = 0; j < (table.rows[i].cells.length)-1; j++) {
            rowData.push(table.rows[i].cells[j].innerText);
        }
        rows.push(rowData);
    }
    
    let csvContent = "data:text/csv;charset=utf-8," 
        + rows.map(e => e.join(",")).join("\n");
    
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", "course_grades.csv");
    document.body.appendChild(link);
    
    link.click(); // Trigger the download
}

// H√†m xu·∫•t Excel
function exportToExcel() {
    const rows = [["T√™n h·ªçc ph·∫ßn", "T√≠n ch·ªâ", "ƒêi·ªÉm C", "ƒêi·ªÉm B", "ƒêi·ªÉm A", "ƒêi·ªÉm h·ªá 10", "ƒêi·ªÉm h·ªá 4"]];
    const table = document.getElementById("courseTableBody");

    for (let i = 0; i < table.rows.length; i++) {
        const rowData = [];
        for (let j = 0; j < (table.rows[i].cells.length)-1; j++) {
            rowData.push(table.rows[i].cells[j].innerText);
        }
        rows.push(rowData);
    }

    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(rows);
    XLSX.utils.book_append_sheet(wb, ws, "Course Grades");

    // T·∫°o Blob t·ª´ Workbook v√† t·∫£i xu·ªëng
    const wbout = XLSX.write(wb, { bookType: "xlsx", type: "binary" });
    const blob = new Blob([s2ab(wbout)], { type: "application/octet-stream" });

    saveAs(blob, "course_grades.xlsx"); // S·ª≠ d·ª•ng th∆∞ vi·ªán FileSaver.js ƒë·ªÉ t·∫£i xu·ªëng file

    function s2ab(s) {
        const buf = new ArrayBuffer(s.length);
        const view = new Uint8Array(buf);
        for (let i = 0; i < s.length; i++) view[i] = s.charCodeAt(i) & 0xFF;
        return buf;
    }
}
document.getElementById('fileInput').addEventListener('change', importFromExcel);
// H√†m nh·∫≠p t·ª´ Excel
function importFromExcel(event) {
    const file = event.target.files[0];

    if (!file) { 
        console.error("Kh√¥ng c√≥ file n√†o ƒë∆∞·ª£c ch·ªçn!");
        return;
    }

    const reader = new FileReader();

    reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });

        // L·∫•y d·ªØ li·ªáu t·ª´ sheet ƒë·∫ßu ti√™n c·ªßa workbook
        const sheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[sheetName];
        let rows = XLSX.utils.sheet_to_json(worksheet);

        // L·ªçc ra c√°c m√¥n h·ªçc
        rows = rows.filter(row => row["T√™n m√¥n h·ªçc"]);
        const list_course = new Set(['7300101','7300102','7300201','7300103','7300104','7300202','7300203','7010701','7010702','7010703'])        
        // Lo·∫°i b·ªè c√°c m√£ h·ªçc ph·∫ßn kh√¥ng h·ª£p l·ªá
        rows = rows.map(row => {
        let courseCode = row["M√£ MH"] ? row["M√£ MH"].toString().trim() : ""; // Chuy·ªÉn v·ªÅ chu·ªói v√† lo·∫°i b·ªè kho·∫£ng tr·∫Øng
        return isNaN(Number(courseCode)) || list_course.has(courseCode) ? null : { ...row, "M√£ MH": Number(courseCode) };
        }).filter(row => row !== null);

        // Chuy·ªÉn ƒë·ªïi d·ªØ li·ªáu sang object
        const formattedRows = rows.map(row => ({
            course_code: row["M√£ MH"],
            subject: row["T√™n m√¥n h·ªçc"],
            credits: row["S·ªë t√≠n ch·ªâ"],
            final_score: row["ƒêi·ªÉm TK (10)"],
            letter_grade: row["ƒêi·ªÉm TK (C)"]
        }));

        // Th√™m d·ªØ li·ªáu v√†o b·∫£ng
        const tableBody = document.getElementById('courseTableBody');
        tableBody.innerHTML = ""; // X√≥a d·ªØ li·ªáu c≈©

        formattedRows.forEach(row => {
            const newRow = tableBody.insertRow();
            newRow.insertCell(0).innerText = row.subject;
            newRow.insertCell(1).innerText = row.credits;
            newRow.insertCell(2).innerText = "";
            newRow.insertCell(3).innerText = "";
            newRow.insertCell(4).innerText = "";
            newRow.insertCell(5).innerText = row.final_score;
            newRow.insertCell(6).innerText = row.letter_grade;
            const gradeCell = newRow.insertCell(7);
            gradeCell.innerHTML = `
                <select class="form-select grade-select" onchange="changeGradeColor(this, '${row.letter_grade}'); updateTotals();">
                    <option value="A+" ${row.letter_grade === "A+" ? "selected" : ""}>A+</option>
                    <option value="A" ${row.letter_grade === "A" ? "selected" : ""}>A</option>
                    <option value="B+" ${row.letter_grade === "B+" ? "selected" : ""}>B+</option>
                    <option value="B" ${row.letter_grade === "B" ? "selected" : ""}>B</option>
                    <option value="C+" ${row.letter_grade === "C+" ? "selected" : ""}>C+</option>
                    <option value="C" ${row.letter_grade === "C" ? "selected" : ""}>C</option>
                    <option value="D+" ${row.letter_grade === "D+" ? "selected" : ""}>D+</option>
                    <option value="D" ${row.letter_grade === "D" ? "selected" : ""}>D</option>
                    <option value="F" ${row.letter_grade === "F" ? "selected" : ""}>F</option>
                </select>
            `;

            // Th√™m n√∫t S·ª≠a v√† X√≥a
            const actionsCell = newRow.insertCell(8);
            actionsCell.innerHTML = `
                <div class="btn-group">
                    <button onclick="editCourse(this)">S·ª≠a</button>
                    <button class="delete-button" onclick="deleteCourse(this)">X√≥a</button>
                </div>`;
            });
        // C·∫≠p nh·∫≠t t·ªïng ƒëi·ªÉm
        updateTotals();
    };
    reader.readAsArrayBuffer(file);
}
function changeGradeColor(selectElement, originalGrade) {
    const gradeOrder = ["F", "D", "D+", "C", "C+", "B", "B+", "A", "A+"]; // Th·ª© t·ª± ƒëi·ªÉm
    const selectedGrade = selectElement.value;
    
    const originalIndex = gradeOrder.indexOf(originalGrade);
    const selectedIndex = gradeOrder.indexOf(selectedGrade);

    // L·∫•y √¥ ch·ª©a select (td)
    const cell = selectElement.parentElement;

    if (selectedIndex > originalIndex) {
        cell.style.backgroundColor = "#4CAF50"; // Xanh l√° n·∫øu tƒÉng ƒëi·ªÉm
        cell.style.color = "white";
    } else if (selectedIndex < originalIndex) {
        cell.style.backgroundColor = "#F44336"; // ƒê·ªè n·∫øu gi·∫£m ƒëi·ªÉm
        cell.style.color = "white";
    } else {
        cell.style.backgroundColor = ""; // Tr·∫£ v·ªÅ m·∫∑c ƒë·ªãnh n·∫øu kh√¥ng ƒë·ªïi
        cell.style.color = "";
    }
}


let isHidden = false;
function toggleCells() {
    const table = document.getElementById("courseTableBody");
    const headers = document.querySelectorAll("thead th");

    // ·∫®n/hi·ªán c√°c c·ªôt trong h√†ng d·ªØ li·ªáu
    for (let i = 0; i < table.rows.length; i++) {
        table.rows[i].cells[2].classList.toggle("hidden-column");
        table.rows[i].cells[3].classList.toggle("hidden-column");
        table.rows[i].cells[4].classList.toggle("hidden-column");
    }

    // ·∫®n/hi·ªán ti√™u ƒë·ªÅ c·ªôt
    headers[2].classList.toggle("hidden-column");
    headers[3].classList.toggle("hidden-column");
    headers[4].classList.toggle("hidden-column");

    // C·∫≠p nh·∫≠t tr·∫°ng th√°i v√† ƒë·ªïi t√™n n√∫t
    isHidden = !isHidden;
    document.querySelector(".round-button").innerText = isHidden ? "Hi·ªán ƒëi·ªÉm th√†nh ph·∫ßn" : "·∫®n ƒëi·ªÉm th√†nh ph·∫ßn";
}

</script>   
    
</body>
</html>
